---
title: "EB_mtab_project_PCA"
author: "KHH"
date: "12/6/2021"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This is a script for replicating the PCA plots generated by Shibl et al to analyze their metabolomic data. Because the datasets are small, and because R plays very well locally but doesn't play as well on the HPC or Jupyter (especially with respect to downloading packages), I think this will work best if any reanalysis is also evaluated locally. Regardless, I've commented out lines that will not play well with the HPC (e.g., figure output). 

Because my initial analysis was performed locally, the data path needs to be changed before reanalysis. This should be relevant when loading data and when outputting figures. I've tried to call attention to those spots. 

#Manual PCA creation - load data, load packages I think I might need

Change data path! 

The data path here reflects my local analysis. Path should be changed to reflect the location of the data - you will need "Dataset_S01_edit_3_R.csv" and "Dataset_S01_metadata.csv," both of which can be found in the jahala directory and github repo under data/clean_data

Data underwent some manual manipulation prior to being used in R: 
 - Metadata information was collapsed into a single identifier to simplify analysis
 - Dataset_S01 was transposed to properly orient data for PCA
 - Metadata (not collapsed into a single identifier) in Dataset_S01 was preserved in a separate file
 

```{r}
require(tidyverse)
require(pcaMethods)
require(rstatix)

mtab_data <- "~/Documents/MIT:WHOI JP/Classes/2021-2022/Environmental_Bioinformatics/Project/Paper/Dataset_S01_edit_3_R.csv"
d_mtab <- read.table(mtab_data, header = FALSE, sep = ",", stringsAsFactors = FALSE)

#log10 transform data, as per methods in Shibl et al. SI
d_mtab_numeric <- d_mtab[c(1:72), c(2:1238)]
d_mtab_numeric_log <- mutate(log10(d_mtab_numeric + 1))

meta_mtab_data <- "~/Documents/MIT:WHOI JP/Classes/2021-2022/Environmental_Bioinformatics/Project/Paper/Dataset_S01_metadata.csv"
d_meta <- read.table(meta_mtab_data, header = TRUE, sep = ",", stringsAsFactors = FALSE)
d_meta$Time <- as.factor(d_meta$Time)

#head(d_mtab)
#head(d_mtab_numeric)
#head(d_mtab_numeric_log)
#head(d_mtab_log)
#head(d_meta)
```

##Make an example PCA, to check that things are working/give me something to work off of

No need to replicate this, unless you're curious about the thought process.

Shibl et al. used MetaboAnalyst in R to generate their PCAs, but MetaboAnalyst wouldn't load in R for me, whether on the HPC, or locally, and in several versions of R. Therefore, I've used the PCA package that MetaboAnalyst uses as a dependency - pcaMethods. 

```{r}
#pc <- pca(iris)
#irdf <- merge(iris, scores(pc), by=0)
#ggplot(irdf, aes(PC1, PC2, colour=Species)) +geom_point() + stat_ellipse()
```

#Try making a PCA using the same exact method

This PCA uses all samples, comparing reseeded vs axenic samples

```{r}
pc <- pca(d_mtab_numeric_log, center = TRUE, scale = "vector", method="svd")
mtab.df <- merge(d_meta, scores(pc), by=0, sort=FALSE)
head(mtab.df)
#ggplot(mtab.df, aes(PC1, PC2, color=Type)) + geom_point(size = 2.5) + stat_ellipse() + theme_bw()
```

Holy heck that's worked better than anything else so far! Unheard of really. Doesn't.. *match* the published figure but it's not dummy different. Flipped the place on the PCAs, and scale is different... probably due to some different normalization? I'm fine with this. 

#Anywho make the same plot and save it

Change file path as appropriate!

```{r}
pdf(file = "~/Documents/MIT:WHOI JP/Classes/2021-2022/Environmental_Bioinformatics/Project/Paper/PCA_axenic_v_reseeded.pdf")
ggplot(mtab.df, aes(PC1, PC2, color=Type)) + geom_point(size = 2.5) + stat_ellipse() + theme_bw()
dev.off()
```

## Split LCMS data and metadata by condition (axenic and reseeded)

The lowest tech way possible tbh, totally failed to get tidyverse-based versions of this to work 

```{r}
dim(d_mtab_numeric_log)
d_mtab_reseeded <- d_mtab_numeric_log[c(1:36), c(1:1237)]
dim(d_mtab_reseeded)
#view(d_mtab_reseeded)

d_mtab_axenic <- d_mtab_numeric_log[c(37:72), c(1:1237)]
dim(d_mtab_axenic)
#view(d_mtab_axenic)
```

Also make subseted meta dataframes

```{r}
dim(d_meta)
d_meta_reseeded <- d_meta[c(1:36), c(1:3)]
dim(d_meta_reseeded)
#view(d_meta_reseeded)

d_meta_axenic <- d_meta[c(37:72), c(1:3)]
dim(d_meta_axenic)
#view(d_meta_axenic)
```

Now make the PCA for each subset, coded by time

#PCA for reseeded samples

```{r}
pc.reseeded <- pca(d_mtab_reseeded, center=TRUE, scale="vector")
reseeded.mtab.df <- merge(d_meta_reseeded, scores(pc.reseeded), by=0, sort=FALSE)
head(reseeded.mtab.df)
#ggplot(reseeded.mtab.df, aes(PC1, PC2, color=Time)) + geom_point(size = 2.5) + stat_ellipse() + theme_bw()
```

##PCA for axenic samples

```{r}
pc.axenic <- pca(d_mtab_axenic, center=TRUE, scale="vector")
axenic.mtab.df <- merge(d_meta_axenic, scores(pc.axenic), by=0, sort=FALSE)
head(axenic.mtab.df)
#ggplot(axenic.mtab.df, aes(PC1, PC2, color=Time)) + geom_point(size = 2.5) + stat_ellipse() + theme_bw()
```

##PCAs for split samples - print to pdf

Change file paths!!

```{r}
pdf(file = "~/Documents/MIT:WHOI JP/Classes/2021-2022/Environmental_Bioinformatics/Project/Paper/PCA_reseeded_by_time.pdf")
ggplot(reseeded.mtab.df, aes(PC1, PC2, color=Time)) + geom_point(size = 2.5) + stat_ellipse() + theme_bw()
dev.off()
```

```{r}
pdf(file = "~/Documents/MIT:WHOI JP/Classes/2021-2022/Environmental_Bioinformatics/Project/Paper/PCA_axenic_by_time.pdf")
ggplot(axenic.mtab.df, aes(PC1, PC2, color=Time)) + geom_point(size = 2.5) + stat_ellipse() + theme_bw()
dev.off()
```

##Compute Mahalanobis distances for axenic and reseeded samples

For this first set, the axenic samples, I'll also check and make sure having metadata in my dataframe doesn't mess with the Mahalanobis distance calculation - looks OK to me

```{r}
subset.axenic.for.maha <- axenic.mtab.df[c(1:36), c(5:6)]
axenic.mahalanobis <- mahalanobis_distance(axenic.mtab.df)
axenic.mahalanobis.alt <- mahalanobis_distance(subset.axenic.for.maha)
head(axenic.mahalanobis)
head(axenic.mahalanobis.alt)
mean(axenic.mahalanobis$mahal.dist)
mean(axenic.mahalanobis.alt$mahal.dist)
```

```{r}
reseeded.mahalanobis <- mahalanobis_distance(reseeded.mtab.df)
head(reseeded.mahalanobis)
mean(reseeded.mahalanobis$mahal.dist)
```
#Possible next steps - make the same plots, using different PCA methods

I'd like to make the same plot, varying the underlying parameters to see what kind of effect those parameters have. This can include parameters detailed in pca(): 
 - center = TRUE/FALSE; 
 - scale = "none" "pareto" "vector" "uv"
 - method = "svd" "ppca" "bpca" "svdImpute" "nipals" "nlpca" -> if nlpca, also include maxSteps=300

