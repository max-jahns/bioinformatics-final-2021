#!/bin/bash

#SBATCH --partition=compute
#SBATCH --job-name=metatranscriptome
#SBATCH --mail-type=ALL
#SBATCH --mail-user=katelane@mit.edu
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=1
#SBATCH --mem=180G
#SBATCH --time=48:00:00
#SBATCH --output=metatranscriptome_%j.log
#export OMP_NUM_THREADS=36

#Run the setup.sh script first

#Note - This script can be broken into parts in order to run on cluster if jobs must be shorter than 48hrs.

##Create conda environment
conda env create -f LANE_metatranscriptome.yml


##Activate conda environment:
conda activate metatranscriptome

#Define rootdir on your computing environment, this is the directory if you type `pwd` inside the directory from cloning this repo. For example, on the Poseidon HPC:
rootdir=/vortexfs1/omics/env-bio/collaboration/jahala/


##Download Data
cd ${rootdir}/data/raw_data/
for i in `cat  ${rootdir}/data/raw_data/access_list_mt.txt`
do
fasterq-dump --split-3 --verbose -O metatranscriptome/ $i
done
#access list is present in /tools/ directory, and in /data/raw_data/ directory. Accession list is also here: SRR10420346 SRR10420347 SRR10420348 SRR10420349 SRR10420350 SRR10420351 SRR10420352 SRR10420353 


##Trim Reads
cd ${rootdir}/data/raw_data/metatranscriptome

for i in `cat  ${rootdir}/data/raw_data/access_list_mt.txt`
do
trimmomatic PE -threads 36 ${i}_1.fastq  ${i}_2.fastq ${i}_1.trimmed.fastq.gz ${i}_1un.trimmed.fastq.gz ${i}_2.trimmed.fastq.gz ${i}_2un.trimmed.fastq.gz ILLUMINACLIP:TruSeq3-PE.fa:2:40:15 MINLEN:75
done
#un is unpaired output, TruSeq3-PE.fa is present in the raw_data/metatranscriptome/ directory and in the the /tools/ directory for reference


##Merge Paired Ends
for i in `cat  ${rootdir}/data/raw_data/access_list_mt.txt`
do
flash -o $i ${i}_1.trimmed.fastq.gz ${i}_2.trimmed.fastq.gz
done


##Remove rRNA reads
for i in `cat  ${rootdir}/data/raw_data/access_list_mt.txt`
do
idx=${rootdir}/tools/sortmerna
sortmerna --ref ${idx}/silva-euk-18s-id95.fasta,${idx}/db1.idx:${idx}/silva-euk-28s-id98.fasta,${idx}/db2.idx \
--ref ${idx}/rfam-5.8s-database-id98.fasta,${idx}/db3.idx:${idx}/rfam-5s-database-id98.fasta,${idx}/db4.idx \
--ref ${idx}/silva-arc-16s-id95.fasta,${idx}/db5.idx:${idx}/silva-arc-23s-id98.fasta,${idx}/db6.idx \
--ref ${idx}/silva-bac-16s-id90.fasta,${idx}/db7.idx:${idx}/silva-bac-23s-id98.fasta,${idx}/db8.idx \
--reads ${rootdir}/data/raw_data/metatranscriptome/${i}.extendedFrags.fastq --sam --num_alignments 1 --fastx --aligned ${rootdir}/data/raw_data/metatranscriptome/out_${i}_aligned_rRNA.fq --other ${rootdir}/data/clean_data/metatranscriptome/out_${i}_filtered_rRNA.fq \
-a 36 -m 180 -v
done
=

#index is available in /tools/ directory, make sure to download there


##Map RNA to metagenome
#keep directory names short with dx_dir
dx_dir=${rootdir}/analysis/metatranscriptome_diff_express/

#concatenate genomes
for i in ${rootdir}/data/raw_data/MAGS/*fna
do
cat $i >> ${dxdir}/all.fa
done

#bowtie2
cd ${dx_dir}
mkdir ${dx_dir}/bt2 #create index directory
bowtie2-build ${dx_dir}/all.fa ${dx_dir}/bt2/all.fa #create index

for i in `cat  ${rootdir}/data/raw_data/access_list_mt.txt`
do
bowtie2 -x dx_dir/bt2/all.fa -U ${rootdir}/data/raw_data/metatranscriptome/${i}.extendedFrags.fastq -S ${dx_dir}/${i}_mapped_all.sam










